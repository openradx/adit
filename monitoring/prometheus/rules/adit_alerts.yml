groups:
  - name: adit_alerts
    rules:
      # High job failure rate alert
      - alert: HighJobFailureRate
        expr: |
          (
            sum(rate(adit_job_status_total{status="FAILURE"}[5m])) /
            sum(rate(adit_job_status_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High job failure rate detected
          description: "Job failure rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      # High task queue depth alert
      - alert: HighTaskQueueDepth
        expr: sum(adit_task_queue_depth) > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: High task queue depth
          description: "There are {{ $value }} pending tasks in the queue"

      # Worker down alert (no tasks processed in 10 minutes)
      - alert: WorkerDown
        expr: |
          sum(rate(adit_task_status_total[10m])) == 0
          and
          sum(adit_task_queue_depth) > 0
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: Workers may be down
          description: "No tasks have been processed in the last 10 minutes while tasks are queued"

      # DICOM operation failure rate alert
      - alert: HighDicomOperationFailureRate
        expr: |
          (
            sum(rate(adit_dicom_operation_total{status="failure"}[5m])) /
            sum(rate(adit_dicom_operation_total[5m]))
          ) > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High DICOM operation failure rate
          description: "DICOM operation failure rate is {{ $value | humanizePercentage }}"

      # High DICOM operation latency
      - alert: HighDicomOperationLatency
        expr: |
          histogram_quantile(0.95, sum(rate(adit_dicom_operation_duration_seconds_bucket[5m])) by (le, operation))
          > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High DICOM operation latency
          description: "95th percentile latency for {{ $labels.operation }} is {{ $value }}s"

      # Django HTTP error rate
      - alert: HighHttpErrorRate
        expr: |
          (
            sum(rate(django_http_responses_total_by_status_view_method{status=~"5.."}[5m])) /
            sum(rate(django_http_responses_total_by_status_view_method[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High HTTP 5xx error rate
          description: "HTTP 5xx error rate is {{ $value | humanizePercentage }}"
