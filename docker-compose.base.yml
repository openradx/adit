x-app: &default-app
  volumes:
    - ${BACKUP_DIR:?}:/backups
    - ${MOUNT_DIR:?}:/mnt
  depends_on:
    - postgres
  environment:
    CALLING_AE_TITLE: ${CALLING_AE_TITLE:?}
    DATABASE_URL: postgres://postgres:postgres@postgres.local:5432/postgres
    DBBACKUP_STORAGE_LOCATION: /backups
    DJANGO_ADMIN_EMAIL: ${DJANGO_ADMIN_EMAIL:?}
    DJANGO_ADMIN_FULL_NAME: ${DJANGO_ADMIN_FULL_NAME:?}
    DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:?}
    DJANGO_CSRF_TRUSTED_ORIGINS: ${DJANGO_CSRF_TRUSTED_ORIGINS:-}
    DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:?}
    DJANGO_SERVER_EMAIL: ${DJANGO_SERVER_EMAIL:?}
    EXCLUDE_MODALITIES: ${EXCLUDE_MODALITIES:-}
    IS_DOCKER_CONTAINER: 1
    FILE_TRANSMIT_HOST: receiver.local
    FILE_TRANSMIT_PORT: 14638
    HTTP_PROXY: ${HTTP_PROXY:-}
    HTTPS_PROXY: ${HTTPS_PROXY:-}
    MOUNT_DIR: /mnt
    NO_PROXY: ${NO_PROXY:-}
    ORTHANC1_DICOM_PORT: 7501
    ORTHANC1_DICOMWEB_ROOT: dicom-web
    ORTHANC1_HOST: orthanc1.local
    ORTHANC1_HTTP_PORT: 6501
    ORTHANC2_DICOM_PORT: 7502
    ORTHANC2_DICOMWEB_ROOT: dicom-web
    ORTHANC2_HOST: orthanc2.local
    ORTHANC2_HTTP_PORT: 6502
    RECEIVER_AE_TITLE: ${RECEIVER_AE_TITLE:?}
    SITE_DOMAIN: ${SITE_DOMAIN:?}
    SITE_NAME: ${SITE_NAME:?}
    STORE_SCP_HOST: receiver.local
    STORE_SCP_PORT: 11112
    SUPERUSER_AUTH_TOKEN: ${SUPERUSER_AUTH_TOKEN:-}
    SUPERUSER_EMAIL: ${SUPERUSER_EMAIL:-}
    SUPERUSER_USERNAME: ${SUPERUSER_USERNAME:-}
    SUPERUSER_PASSWORD: ${SUPERUSER_PASSWORD:-}
    SUPPORT_EMAIL: ${SUPPORT_EMAIL:?}
    TIME_ZONE: ${TIME_ZONE:?}
    TOKEN_AUTHENTICATION_SALT: ${TOKEN_AUTHENTICATION_SALT:?}
    ANONYMIZATION_SEED: ${ANONYMIZATION_SEED:-}

services:
  init:
    <<: *default-app
    hostname: init.local

  web:
    <<: *default-app
    build:
      args:
        - PROJECT_VERSION=${PROJECT_VERSION:?}
    hostname: web.local

  default_worker:
    <<: *default-app
    hostname: default_worker.local

  dicom_worker:
    <<: *default-app
    hostname: dicom_worker.local

  receiver:
    <<: *default-app
    hostname: receiver.local

  postgres:
    image: postgres:17
    hostname: postgres.local
    volumes:
      - postgres_data:/var/lib/postgresql/data

  orthanc1:
    image: jodogne/orthanc-plugins:1.12.10
    hostname: orthanc1.local
    configs:
      - source: orthanc1_config
        target: /etc/orthanc/orthanc.json
    volumes:
      - orthanc1_data:/var/lib/orthanc/db

  orthanc2:
    image: jodogne/orthanc-plugins:1.12.10
    hostname: orthanc2.local
    configs:
      - source: orthanc2_config
        target: /etc/orthanc/orthanc.json
    volumes:
      - orthanc2_data:/var/lib/orthanc/db

  prometheus:
    image: prom/prometheus:v2.50.0
    hostname: prometheus.local
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
      - source: prometheus_alerts
        target: /etc/prometheus/rules/adit_alerts.yml
    volumes:
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'

  grafana:
    image: grafana/grafana:10.3.0
    hostname: grafana.local
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    configs:
      - source: grafana_datasources
        target: /etc/grafana/provisioning/datasources/datasource.yml
      - source: grafana_dashboards
        target: /etc/grafana/provisioning/dashboards/dashboard.yml
      - source: grafana_adit_dashboard
        target: /var/lib/grafana/dashboards/adit-overview.json
    volumes:
      - grafana_data:/var/lib/grafana

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    hostname: cadvisor.local
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro

configs:
  orthanc1_config:
    file: ./orthanc/orthanc1.json
  orthanc2_config:
    file: ./orthanc/orthanc2.json
  prometheus_config:
    file: ./monitoring/prometheus/prometheus.yml
  prometheus_alerts:
    file: ./monitoring/prometheus/rules/adit_alerts.yml
  grafana_datasources:
    file: ./monitoring/grafana/provisioning/datasources/datasource.yml
  grafana_dashboards:
    file: ./monitoring/grafana/provisioning/dashboards/dashboard.yml
  grafana_adit_dashboard:
    file: ./monitoring/grafana/dashboards/adit-overview.json

volumes:
  postgres_data:
  orthanc1_data:
  orthanc2_data:
  prometheus_data:
  grafana_data:
